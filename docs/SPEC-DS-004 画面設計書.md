# 仕様書作成支援ボット 画面設計書

| バージョン | ステータス | 作成日 | 参照ドキュメント |
| :--- | :--- | :--- | :--- |
| **v1.7** | **最新版** | 2025/01/17 | 要件定義書 v3.5, 基本設計書 v1.5, JSON階層フィルター機能仕様書 v1.0 |

**v1.7更新内容:**
- LLMプロセス可視化エリア仕様追加（3.5章新設）
- アコーディオン形式のリアルタイム処理プロセス表示機能
- 5段階プロセス（質問解析→ツール選択→検索実行→結果統合→回答生成）の詳細UI設計
- プロセス進行インジケーターとexpander構成要素の仕様定義

**v1.6更新内容:**
- Jiraフィルター強化版のUI設計追加（2章新設）
- 3→12パラメータ対応のアコーディオン型UI設計
- JSON階層フィルター機能強化版のUI設計追加（3章新設）
- 削除ページフィルター・階層チェックボックスのUI仕様
- Before/After比較図による変更内容の明確化

---

## 1. 概要
本ドキュメントは、「仕様書作成支援ボット」のユーザーインターフェース（UI）を定義するものである。画面のレイアウト、構成要素、およびユーザーの操作に対する応答（インタラクション）を明確にし、開発者とプロジェクト関係者の共通認識を形成することを目的とする。

---

## 2. 画面モックアップ

### 2.1. メイン画面 (MVP)
アプリケーションの画面は、**メインのチャットエリア**と、**左側のサイドバーエリア**で構成される。サイドバーには、検索を詳細に絞り込むためのオプションを**アコーディオン形式（Expander）**で配置する。

+--------------------------------+---------------------------------------------+
| [サイドバーエリア]             | [メインチャットエリア]                      |
|                                |                                             |
|  絞り込み検索オプション        |  📝 仕様書作成支援ボトット                  |
|  ----------------------------  |  -----------------------------------------  |
|                                |                                             |
|  [ Jira フィルター ▼ ]         |  [Bot] こんにちは！左のサイドバーで検索条件 |
|                                |        を絞り込めます。準備ができたら...   |
|  [ Confluence フィルター ▼ ]   |                                             |
|                                |  ...                                        |
|  ----------------------------  |                                             |
|                                |                                             |
|  [ 🔄 選択肢を更新 ]           |                                             |
|                                |                                             |
+--------------------------------+---------------------------------------------+

*ユーザーが `[ Jira フィルター ▼ ]` をクリックすると、Jira関連のフィルター項目（ステータス、担当者など）が展開表示される。*

### 2.2. 会話履歴ブラウザ (将来拡張)
将来の拡張機能として、サイドバーに「会話履歴」ボタンを設置し、クリックすると以下のモーダルウィンドウが表示される。

+----------------------------------------------------------------------+
| 💬 会話履歴ブラウザ                                             [ X ]|
|----------------------------------------------------------------------|
| [ 履歴を検索...      ]                                               |
|----------------------------------------------------------------------|
| [履歴一覧 (左ペイン)]          | [選択された会話 (右ペイン)]         |
|                                |                                     |
|  - ログイン機能について        |  [User] ログイン機能について教えて  |
|    (07/17 10:30)               |                                     |
|                                |  [Bot] 【ログイン機能に関する要約】 |
|  - パスワードリセットの仕様    |        ...                          |
|    (07/17 09:45)               |                                     |
+----------------------------------------------------------------------+


---

## 3. 画面構成要素の詳細

### 3.1. ヘッダーエリア (メインチャットエリア内)
* **要素:** アプリケーションタイトル
* **表示内容:** 「📝 仕様書作成支援ボット」

### 3.2. チャット履歴エリア (メインチャットエリア内)
* **要素:** システムメッセージ、ユーザーメッセージ
* **役割:** ユーザーとボットの対話履歴を表示する。

### 3.3. 入力エリア (メインチャットエリア内)
* **要素:** チャット入力ボックス、送信ボタン
* **役割:** ユーザーが検索キーワードを入力するためのインターフェース。

### 3.4. サイドバーエリア (MVP)
* **役割:** 検索対象を詳細に絞り込むためのオプションを提供する。
* **フィルターグループ (`st.expander`):**
    * **表示内容:** 「Jira フィルター」「Confluence フィルター」といったタイトル。
    * **動作:** 各タイトルをクリックすると、関連するフィルター項目（ステータス選択、担当者入力など）がアコーディオン形式で展開・格納される。
* **選択肢更新ボタン (`st.button`):**
    * **表示内容:** 「🔄 選択肢を更新」
    * **動作:** クリックすると、フィルター用の選択肢データを保持しているキャッシュを強制的にクリアし、APIから最新の情報を再取得する。

### 3.5. LLMプロセス可視化エリア (v1.7新機能)
* **要素:** プロセス進行状況表示、アコーディオン式詳細表示
* **役割:** チャット回答生成中に、LLMエージェントの思考プロセスをリアルタイムで可視化する。
* **表示位置:** チャット履歴エリア内の回答生成中メッセージ内
* **UI構成:**
    * **プロセス進行インジケーター (`st.progress`):**
        * **表示内容:** 全体的な処理進行度（0-100%）
        * **動作:** 各プロセス段階の完了に応じて進行度を更新
    * **プロセス段階表示 (`st.expander`):**
        * **表示内容:** 各処理段階のタイトルとステータス
        * **動作:** 完了済み段階は展開可能、実行中段階はスピナー表示、未実行段階はグレーアウト

#### **プロセス段階定義:**
```
🤖 回答生成中...                                    [████████████░░░░] 75%

🔍 1. 質問解析                                        ✅ 完了 ▼
    ├─ 検出キーワード: "ログイン", "機能", "仕様"
    ├─ 推定検索対象: Jira, Confluence
    └─ フィルター条件: ステータス="進行中"

🛠️ 2. ツール選択                                     ✅ 完了 ▼  
    ├─ 選択ツール: Jira検索, Confluence検索
    ├─ 優先順位: Confluence → Jira
    └─ 実行戦略: 並列検索

📊 3. 検索実行                                        🔄 実行中... ▼
    ├─ Confluence検索: 実行完了 (7件取得)
    ├─ Jira検索: 実行中...
    └─ 詳細クエリ: project = "CTJ" AND status = "進行中"

🔗 4. 結果統合                                        ⏳ 待機中
    └─ 関連性分析、重複除去、優先度付け

✍️ 5. 回答生成                                       ⏳ 待機中  
    └─ AI要約、参照リンク生成、最終チェック
```

* **プロセス詳細情報の表示項目:**
    * **質問解析段階:** 検出キーワード、推定検索対象、適用フィルター
    * **ツール選択段階:** 選択されたツール、実行優先順位、検索戦略
    * **検索実行段階:** 実行中ツール、取得件数、詳細クエリ、実行時間
    * **結果統合段階:** マッチ度、重複除去件数、カテゴリ分類
    * **回答生成段階:** 要約精度、参照リンク数、生成文字数

---

## 2. Jiraフィルター強化版 (v1.6追加)

### 2.1. 改善背景
従来のJiraフィルター（3パラメータ）では複雑な条件での絞り込みが困難だったため、12パラメータ対応の詳細フィルター機能を開発。

### 2.2. UI変更内容

#### **Before (従来版):**
```
📋 Jiraフィルター
├── プロジェクト: [CTJ ▼]
├── ステータス: [すべて ▼]
└── 担当者: [すべて ▼]
```

#### **After (強化版):**
```
📋 Jiraフィルター（詳細対応）
├── 🔧 基本フィルター
│   ├── プロジェクト: [CTJ ▼]
│   ├── ステータス: [すべて ▼]
│   ├── 担当者: [すべて ▼]
│   ├── チケットタイプ: [すべて ▼]       ← 新機能
│   ├── 優先度: [すべて ▼]             ← 新機能
│   └── 報告者: [すべて ▼]             ← 新機能
│
├── 🎯 CTJ専用フィールド               ← 新機能
│   ├── 担当（CF10277）: [すべて ▼]
│   └── 影響業務（CF10291）: [すべて ▼]
│
└── 📅 日付フィルター                  ← 新機能
    ├── 作成日: [____] ～ [____]
    ├── 更新日: [____] ～ [____]
    ├── 解決日: [____] ～ [____]
    └── 期限: [____] ～ [____]
```

### 2.3. 新機能詳細

#### **アコーディオン型UI:**
- **表示**: 段階的に展開可能な3セクション構成
- **デフォルト**: 基本フィルターのみ展開、他は折りたたみ
- **操作性**: ワンクリックで各セクションの開閉

#### **複雑なJQLクエリ対応:**
- **表示例**: 画面下部に生成されたJQLを表示
```
📊 検索条件: project = CTJ AND status IN ("To Do", "In Progress") 
AND assignee = "ejiri_yusuke" AND created >= "2024-01-01"
```

#### **リアルタイムバリデーション:**
- **日付検証**: 開始日 ≤ 終了日の自動チェック
- **組み合わせ**: 矛盾する条件の警告表示
- **パフォーマンス**: 条件変更時の即座の件数表示

### 2.4. パフォーマンス指標
- **フィルター適用**: 0.5秒以内
- **選択肢更新**: 初回3-5秒、キャッシュ時0.1秒
- **複雑クエリ**: 10条件組み合わせでも2秒以内

---

## 3. Confluenceフィルター強化版 (v1.6追加)

### 3.1. 改善背景
従来のConfluenceフィルター機能の性能課題（3-10秒の待機時間）と操作性の問題を解決するため、JSON階層フィルター機能を新規開発。

### 3.2. UI変更内容

#### **Before (従来版):**
```
📚 Confluenceフィルター
├── スペース: [CLIENTTOMO ▼]          ← 削除
├── コンテンツタイプ: [page ▼]        ← 削除  
├── ページ階層フィルター
└── 日付フィルター
```

#### **After (強化版):**
```
📚 Confluenceフィルター（簡素化）
├── 🗑️ フィルターオプション
│   ☐ 削除ページを含む              ← 新機能
│   📊 除外: 12件（【%%削除%%】8件、【%%廃止%%】4件）
│
├── 📁 ページ階層フィルター          ← 強化
│   ☑️ 📁 ■要件定義 (33件)
│   │   ☑️ 📄 機能仕様書 v2.1
│   │   🗑️ 📄 【%%削除%%】旧機能仕様書  ← 削除ページ表示例
│   └── ☑️ 📁 テスト要件 (8件)
│
└── 📅 日付フィルター
    ├── 作成日: [____] ～ [____]
    └── 更新日: [____] ～ [____]
```

### 3.3. 新機能詳細

#### **削除ページフィルター:**
- **表示**: チェックボックス「🗑️ 削除ページを含む」
- **デフォルト**: OFF（削除・廃止ページを除外）
- **ON時**: 削除ページも表示（🗑️アイコン付き）
- **統計表示**: 除外されたページ数の表示

#### **階層チェックボックス:**
- **表示形式**: インデント付き階層構造
- **選択方式**: 親選択で配下全選択
- **パフォーマンス**: 即座の応答（0.1秒以下）

### 3.4. 検索結果表示
```
🔍 検索結果: 25件 (除外された削除ページ: 3件)

📄 機能仕様書 v2.1                    ■要件定義
📄 テスト設計書                       ■要件定義 > テスト要件
🗑️ 【%%削除%%】旧機能仕様書         ■要件定義    (削除ページ含む=ON時のみ)
```

**📄 詳細仕様:** [JSON階層フィルター機能_仕様書.md](./JSON階層フィルター機能_仕様書.md#ui改善設計) 参照
