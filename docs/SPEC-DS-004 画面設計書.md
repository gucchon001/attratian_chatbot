# 仕様書作成支援ボット 画面設計書

| バージョン | ステータス | 作成日 | 参照ドキュメント |
| :--- | :--- | :--- | :--- |
| **v1.8** | **最新版** | 2025/01/24 | 要件定義書 v3.5, 基本設計書 v1.5, JSON階層フィルター機能仕様書 v1.0 |

**v1.8更新内容:**
- 統合思考プロセス表示の仕様更新（3.5章改訂）
- 5段階→1つの統合アコーディオン形式に変更
- 会話履歴クリアボタンの仕様追加
- ワンクリック深掘り検索機能のUI仕様追加
- フラット表示・ネスト解消の設計思想反映

**v1.7更新内容:**
- LLMプロセス可視化エリア仕様追加（3.5章新設）
- アコーディオン形式のリアルタイム処理プロセス表示機能
- 5段階プロセス（質問解析→ツール選択→検索実行→結果統合→回答生成）の詳細UI設計
- プロセス進行インジケーターとexpander構成要素の仕様定義

**v1.6更新内容:**
- Jiraフィルター強化版のUI設計追加（2章新設）
- 3→12パラメータ対応のアコーディオン型UI設計
- JSON階層フィルター機能強化版のUI設計追加（3章新設）
- 削除ページフィルター・階層チェックボックスのUI仕様
- Before/After比較図による変更内容の明確化

---

## 1. 概要
本ドキュメントは、「仕様書作成支援ボット」のユーザーインターフェース（UI）を定義するものである。画面のレイアウト、構成要素、およびユーザーの操作に対する応答（インタラクション）を明確にし、開発者とプロジェクト関係者の共通認識を形成することを目的とする。

---

## 2. 画面モックアップ

### 2.1. メイン画面 (MVP)
アプリケーションの画面は、**メインのチャットエリア**と、**左側のサイドバーエリア**で構成される。サイドバーには、検索を詳細に絞り込むためのオプションを**アコーディオン形式（Expander）**で配置する。

+--------------------------------+---------------------------------------------+
| [サイドバーエリア]             | [メインチャットエリア]                      |
|                                |                                             |
|  絞り込み検索オプション        |  📝 仕様書作成支援ボトット                  |
|  ----------------------------  |  -----------------------------------------  |
|                                |                                             |
|  [ Jira フィルター ▼ ]         |  [Bot] こんにちは！左のサイドバーで検索条件 |
|                                |        を絞り込めます。準備ができたら...   |
|  [ Confluence フィルター ▼ ]   |                                             |
|                                |  ...                                        |
|  ----------------------------  |                                             |
|                                |                                             |
|  [ 🔄 選択肢を更新 ]           |                                             |
|                                |                                             |
+--------------------------------+---------------------------------------------+

*ユーザーが `[ Jira フィルター ▼ ]` をクリックすると、Jira関連のフィルター項目（ステータス、担当者など）が展開表示される。*

### 2.2. 会話履歴ブラウザ (将来拡張)
将来の拡張機能として、サイドバーに「会話履歴」ボタンを設置し、クリックすると以下のモーダルウィンドウが表示される。

+----------------------------------------------------------------------+
| 💬 会話履歴ブラウザ                                             [ X ]|
|----------------------------------------------------------------------|
| [ 履歴を検索...      ]                                               |
|----------------------------------------------------------------------|
| [履歴一覧 (左ペイン)]          | [選択された会話 (右ペイン)]         |
|                                |                                     |
|  - ログイン機能について        |  [User] ログイン機能について教えて  |
|    (07/17 10:30)               |                                     |
|                                |  [Bot] 【ログイン機能に関する要約】 |
|  - パスワードリセットの仕様    |        ...                          |
|    (07/17 09:45)               |                                     |
+----------------------------------------------------------------------+


---

## 3. 画面構成要素の詳細

### 3.1. ヘッダーエリア (メインチャットエリア内)
* **要素:** アプリケーションタイトル
* **表示内容:** 「📝 仕様書作成支援ボット」

### 3.2. チャット履歴エリア (メインチャットエリア内)
* **要素:** システムメッセージ、ユーザーメッセージ
* **役割:** ユーザーとボットの対話履歴を表示する。

### 3.3. 入力エリア (メインチャットエリア内)
* **要素:** チャット入力ボックス、送信ボタン
* **役割:** ユーザーが検索キーワードを入力するためのインターフェース。

### 3.4. サイドバーエリア (MVP)
* **役割:** 検索対象を詳細に絞り込むためのオプションを提供する。
* **フィルターグループ (`st.expander`):**
    * **表示内容:** 「Jira フィルター」「Confluence フィルター」といったタイトル。
    * **動作:** 各タイトルをクリックすると、関連するフィルター項目（ステータス選択、担当者入力など）がアコーディオン形式で展開・格納される。
* **選択肢更新ボタン (`st.button`):**
    * **表示内容:** 「🔄 選択肢を更新」
    * **動作:** クリックすると、フィルター用の選択肢データを保持しているキャッシュを強制的にクリアし、APIから最新の情報を再取得する。

### 3.5. LLMプロセス可視化エリア (v1.8統合仕様)
* **要素:** 統合思考プロセス表示、会話履歴クリアボタン、ワンクリック深掘り機能
* **役割:** チャット回答生成中に、LLMエージェントの思考プロセスを統合的に可視化する。
* **表示位置:** チャット履歴エリア内の回答生成中メッセージ内
* **UI構成:**
    * **統合思考プロセスアコーディオン (`st.expander`):**
        * **表示内容:** 「🤖 思考プロセスを表示」
        * **動作:** ワンクリックで全段階の詳細処理を一括表示・折りたたみ
        * **設計思想:** 5段階の個別アコーディオンを1つに統合してネスト解消
    * **会話履歴クリアボタン (`st.button`):**
        * **表示条件:** 会話履歴が1件以上存在する場合のみ表示
        * **表示内容:** 「🗑️ 履歴クリア (件数)」
        * **動作:** クリックで会話履歴+エージェントメモリーを完全削除、st.rerun()で即座に反映
    * **ワンクリック深掘り検索 (`st.button`):**
        * **表示条件:** 検索結果表示後に関連キーワードとして表示
        * **表示内容:** 関連する専門用語・概念のボタン群
        * **動作:** クリックで自動的に深掘り質問を生成・実行、メモリー機能で文脈保持

#### **統合思考プロセス表示例:**
```
🤖 思考プロセスを表示 ▼

【Step 1: キーワード抽出・分析】
├─ 元質問: "ログイン機能について教えて"
├─ 抽出キーワード: ["ログイン", "認証", "セッション"]
├─ 除去した汎用句: ["について", "教えて", "機能"]
└─ 専門用語辞書マッチ: "ログイン" → "認証システム"

【Step 2: データソース判定】
├─ 最適データソース: Confluence (スコア: 0.9)
├─ 検索スペース: CLIENTTOMO
└─ 推定ドキュメントタイプ: 機能仕様書

【Step 3: CQL検索実行】
├─ Strategy1 (タイトル優先): 2件ヒット
├─ Strategy2 (本文AND検索): 5件ヒット  
├─ Strategy3 (フレーズ検索): 1件ヒット
└─ 統合結果: 7件 → 重複除去 → 3件

【Step 4: 品質評価・関連度算出】
├─ 関連度評価: 平均 0.88 (目標 0.80 達成)
├─ 内容品質: 機能仕様書 3件、設計書 0件
├─ 新鮮度: 最新更新 2024/12月
└─ カバレッジ: 会員/企業管理者/全体管理者 全てカバー

【Step 5: 最終回答生成】
├─ 要約戦略: 機能別分類 + 共通要素抽出
├─ 参照リンク: 3件の仕様書直リンク
└─ 関連概念: セッション管理, パスワードポリシー, 権限制御

🔍 深掘り検索: [セッション管理] [パスワードポリシー] [権限制御] [二要素認証]
🗑️ 履歴クリア (3件)
```

* **統合アコーディオンの利点:**
    * **ネスト解消**: 5層の階層構造を1層のフラット表示に変更
    * **一覧性向上**: 全プロセスを一目で把握可能
    * **操作性改善**: ワンクリックで全情報の表示・非表示
    * **画面効率**: 縦スクロール量の大幅削減

#### **ワンクリック深掘り検索機能:**
* **関連キーワード自動生成**: エージェントが検索結果から関連概念を抽出
* **ボタン形式表示**: クリックしやすいボタンとして配置
* **メモリー連携**: 前回の検索コンテキストを保持して深掘り
* **表示例**: 
  ```
  🔍 さらに詳しく調べる:
  [セッション管理の仕組み] [パスワードポリシー設定] [権限制御詳細] 
  [ログアウト処理] [セキュリティ要件] [多要素認証]
  ```

#### **会話履歴クリアボタン:**
* **表示タイミング**: 会話履歴追加後、st.rerun()で即座に表示
* **完全削除**: Streamlit session_state + LangChainメモリー両方クリア
* **件数表示**: 現在の履歴件数を動的に表示
* **確認なし**: ワンクリックで即座に実行（シンプル操作）

---

## 2. Jiraフィルター強化版 (v1.6追加)

### 2.1. 改善背景
従来のJiraフィルター（3パラメータ）では複雑な条件での絞り込みが困難だったため、12パラメータ対応の詳細フィルター機能を開発。

### 2.2. UI変更内容

#### **Before (従来版):**
```
📋 Jiraフィルター
├── プロジェクト: [CTJ ▼]
├── ステータス: [すべて ▼]
└── 担当者: [すべて ▼]
```

#### **After (強化版):**
```
📋 Jiraフィルター（詳細対応）
├── 🔧 基本フィルター
│   ├── プロジェクト: [CTJ ▼]
│   ├── ステータス: [すべて ▼]
│   ├── 担当者: [すべて ▼]
│   ├── チケットタイプ: [すべて ▼]       ← 新機能
│   ├── 優先度: [すべて ▼]             ← 新機能
│   └── 報告者: [すべて ▼]             ← 新機能
│
├── 🎯 CTJ専用フィールド               ← 新機能
│   ├── 担当（CF10277）: [すべて ▼]
│   └── 影響業務（CF10291）: [すべて ▼]
│
└── 📅 日付フィルター                  ← 新機能
    ├── 作成日: [____] ～ [____]
    ├── 更新日: [____] ～ [____]
    ├── 解決日: [____] ～ [____]
    └── 期限: [____] ～ [____]
```

### 2.3. 新機能詳細

#### **アコーディオン型UI:**
- **表示**: 段階的に展開可能な3セクション構成
- **デフォルト**: 基本フィルターのみ展開、他は折りたたみ
- **操作性**: ワンクリックで各セクションの開閉

#### **複雑なJQLクエリ対応:**
- **表示例**: 画面下部に生成されたJQLを表示
```
📊 検索条件: project = CTJ AND status IN ("To Do", "In Progress") 
AND assignee = "ejiri_yusuke" AND created >= "2024-01-01"
```

#### **リアルタイムバリデーション:**
- **日付検証**: 開始日 ≤ 終了日の自動チェック
- **組み合わせ**: 矛盾する条件の警告表示
- **パフォーマンス**: 条件変更時の即座の件数表示

### 2.4. パフォーマンス指標
- **フィルター適用**: 0.5秒以内
- **選択肢更新**: 初回3-5秒、キャッシュ時0.1秒
- **複雑クエリ**: 10条件組み合わせでも2秒以内

---

## 3. Confluenceフィルター強化版 (v1.6追加)

### 3.1. 改善背景
従来のConfluenceフィルター機能の性能課題（3-10秒の待機時間）と操作性の問題を解決するため、JSON階層フィルター機能を新規開発。

### 3.2. UI変更内容

#### **Before (従来版):**
```
📚 Confluenceフィルター
├── スペース: [CLIENTTOMO ▼]          ← 削除
├── コンテンツタイプ: [page ▼]        ← 削除  
├── ページ階層フィルター
└── 日付フィルター
```

#### **After (強化版):**
```
📚 Confluenceフィルター（簡素化）
├── 🗑️ フィルターオプション
│   ☐ 削除ページを含む              ← 新機能
│   📊 除外: 12件（【%%削除%%】8件、【%%廃止%%】4件）
│
├── 📁 ページ階層フィルター          ← 強化
│   ☑️ 📁 ■要件定義 (33件)
│   │   ☑️ 📄 機能仕様書 v2.1
│   │   🗑️ 📄 【%%削除%%】旧機能仕様書  ← 削除ページ表示例
│   └── ☑️ 📁 テスト要件 (8件)
│
└── 📅 日付フィルター
    ├── 作成日: [____] ～ [____]
    └── 更新日: [____] ～ [____]
```

### 3.3. 新機能詳細

#### **削除ページフィルター:**
- **表示**: チェックボックス「🗑️ 削除ページを含む」
- **デフォルト**: OFF（削除・廃止ページを除外）
- **ON時**: 削除ページも表示（🗑️アイコン付き）
- **統計表示**: 除外されたページ数の表示

#### **階層チェックボックス:**
- **表示形式**: インデント付き階層構造
- **選択方式**: 親選択で配下全選択
- **パフォーマンス**: 即座の応答（0.1秒以下）

### 3.4. 検索結果表示
```
🔍 検索結果: 25件 (除外された削除ページ: 3件)

📄 機能仕様書 v2.1                    ■要件定義
📄 テスト設計書                       ■要件定義 > テスト要件
🗑️ 【%%削除%%】旧機能仕様書         ■要件定義    (削除ページ含む=ON時のみ)
```

**📄 詳細仕様:** [JSON階層フィルター機能_仕様書.md](./JSON階層フィルター機能_仕様書.md#ui改善設計) 参照
