# JSON階層フィルター機能 仕様書

| バージョン | ステータス | 作成日 | 関連ドキュメント |
| :--- | :--- | :--- | :--- |
| **v1.0** | **実装仕様書** | 2025/01/17 | [要件定義書 v3.5](./仕様書作成支援ボット%20要件定義書.md) |

## 📋 概要

既存のConfluence APIリアルタイム取得から、**ローカルJSONファイルベースの階層フィルター機能**に変更することで、パフォーマンスを大幅に向上させる。

### **関連仕様書:**
- 📄 [要件定義書 v3.5](./仕様書作成支援ボット%20要件定義書.md#312-json階層フィルター機能強化v35追加) - 全体要件・背景
- 📄 [画面設計書 v1.6](./仕様書作成支援ボット%20画面設計書.md#3-confluenceフィルター強化版-v16追加) - UI設計・操作仕様
- 📄 [外部インターフェース設計書 v2.1](./仕様書作成支援ボット%20外部インターフェース設計書.md#eif-06-json階層データインターフェース) - EIF-06 データインターフェース
- 📄 [テスト仕様書 v1.1](./仕様書作成支援ボット%20テスト仕様書.md) - ST-05, ST-06, NFT-04 テストケース

## 🎯 目標

### **パフォーマンス向上:**
- 現在: API呼び出し（3-10秒） → 目標: ローカル読み込み（0.1秒以下）
- 初回読み込み時間の大幅短縮
- ユーザー待機時間の解消

### **機能強化:**
- 階層チェックボックスによる直感的なフォルダ選択
- 親フォルダ選択で配下全ページの自動選択
- フォルダ構造の視覚的表示

### **フィルター機能の改善:**
- 不要な機能（スペース・コンテンツタイプ選択）の削除
- 削除・廃止ページの自動除外とオプション表示
- よりシンプルで使いやすいUI

## 📊 現状と課題

### **現在の問題:**
| 項目 | 現状 | 問題 |
|------|------|------|
| データ取得 | リアルタイムAPI | 3-10秒の待機時間 |
| 階層表示 | 文字列解析 | 複雑で不安定 |
| フィルター | 限定的 | フォルダ単位選択不可 |
| UX | 毎回待機 | ユーザビリティ低下 |

### **解決する課題:**
1. **パフォーマンス** - API待機時間の解消
2. **安定性** - 文字列解析エラーの回避  
3. **使いやすさ** - 階層チェックボックスUI
4. **保守性** - 構造化データによる管理向上

## 📋 新機能要件詳細

### **1. 削除する機能:**
| 機能 | 現状 | 変更後 | 理由 |
|------|------|--------|------|
| スペース選択 | 50個のスペースから選択 | **削除** | CLIENTTOMO固定で十分 |
| コンテンツタイプ選択 | page/blogpostから選択 | **削除** | pageのみで十分 |

### **2. 削除・廃止ページフィルター:**

#### **2.1. デフォルト除外:**
- **対象パターン:** ページタイトルに以下を含むもの
  - `【%%削除%%】`
  - `【%%廃止%%】`
- **動作:** 検索結果から自動的に除外
- **表示:** 除外された件数を表示

#### **2.2. オプション表示:**
- **UI:** チェックボックス「🗑️ 削除ページを含む」
- **デフォルト:** OFF（除外状態）
- **ON時:** 削除・廃止ページも検索対象に含む
- **表示:** 削除ページには `🗑️` アイコンを付与

### **3. 階層フィルター（既存機能強化）:**
- **表示形式:** 階層チェックボックス
- **選択方式:** 親選択で配下全選択
- **データ源:** ローカルJSONファイル

## 🎨 UI改善設計

### **Before (現在):**
```
📚 Confluenceフィルター
├── スペース: [CLIENTTOMO ▼]          ← 削除
├── コンテンツタイプ: [page ▼]        ← 削除
├── ページ階層フィルター
└── 日付フィルター
```

### **After (改善後):**
```
📚 Confluenceフィルター
├── 🗑️ フィルターオプション
│   ☐ 削除ページを含む              ← 新機能
│   📊 除外: 12件（【%%削除%%】8件、【%%廃止%%】4件）
│
├── 📁 ページ階層フィルター
│   ☑️ 📁 ■要件定義 (33件)
│   │   ☑️ 📄 機能仕様書 v2.1
│   │   🗑️ 📄 【%%削除%%】旧機能仕様書  ← 削除ページ表示例
│   └── ☑️ 📁 テスト要件 (8件)
│
└── 📅 日付フィルター
    ├── 作成日: [____] ～ [____]
    └── 更新日: [____] ～ [____]
```

### **検索結果表示例:**
```
🔍 検索結果: 25件 (除外された削除ページ: 3件)

📄 機能仕様書 v2.1                    ■要件定義
📄 テスト設計書                       ■要件定義 > テスト要件
🗑️ 【%%削除%%】旧機能仕様書         ■要件定義    (削除ページ含む=ON時のみ)
```

## 🏗️ システム設計

### **1. データフロー:**

```
[Confluence API] → [構造解析] → [JSON保存] → [UI表示] → [フィルタリング]
     ↓              ↓            ↓            ↓            ↓
  週1回更新     テキスト→JSON  ローカル保存   階層UI      検索絞り込み
```

### **2. ファイル構成:**

```
data/
├── confluence_hierarchy.json      # 現在の階層データ
├── confluence_hierarchy_backup.json # バックアップ
└── cache_metadata.json           # 更新情報・統計
```

### **3. JSON構造:**

```json
{
  "space_name": "client-tomonokai-juku",
  "space_key": "CLIENTTOMO",
  "generated_at": "2025-01-17T16:27:59",
  "total_pages": 1129,
  "last_updated": "2025-01-17T16:27:59",
  "version": "1.0",
  "folders": [
    {
      "id": "folder_001",
      "name": "■要件定義",
      "type": "folder",
      "updated": "2023-06-28 03:08",
      "page_count": 45,
      "children": [
        {
          "id": "640450787",
          "name": "サーバー環境情報まとめ",
          "type": "folder",
          "updated": "2024-10-07 04:29",
          "page_count": 12,
          "children": [...]
        }
      ]
    }
  ]
}
```

## 💻 機能仕様

### **1. データ更新機能:**

#### **自動更新:**
- **頻度**: 週1回（月曜日 AM 3:00）
- **方法**: バックグラウンドタスク
- **差分検知**: Confluence最終更新日時比較
- **フォールバック**: API障害時は既存データ使用

#### **手動更新:**
- **トリガー**: サイドバー「🔄 階層データ更新」ボタン
- **処理時間**: 30-60秒（プログレスバー表示）
- **エラー処理**: 失敗時は既存データ保持

#### **更新プロセス:**
```python
1. Confluence API接続確認
2. 最終更新日時取得・比較
3. 新規/更新ページのみ取得
4. JSON構造再構築
5. バックアップ作成
6. 新JSONファイル保存
7. UI反映
```

### **2. 階層フィルターUI:**

#### **表示仕様:**
```
📊 検索対象データソース
  ☑️ Confluence (仕様書・ドキュメント)  
  ☑️ Jira (チケット・タスク)

📁 ページ階層フィルター (新機能)
  ☑️ 📁 ■要件定義 (45ページ)
    ☑️ 📁 サーバー環境情報まとめ (12ページ)  
      ☑️ 📄 STG・DEV環境テストアカウント
      ☑️ 📄 環境アクセス情報
    ☑️ 📁 テスト要件 (8ページ)
    ☑️ 📄 スコープ外
  ☐ 📁 データ移行・リリース計画 (156ページ)
  ☐ 📁 メールテンプレート (89ページ)

選択中: 2フォルダ、65ページ
```

#### **チェックボックス動作:**
- **親フォルダ選択** → 配下全ページ自動選択
- **子ページ部分選択** → 親フォルダは中間状態表示
- **全選択・全解除** ボタン提供
- **フォルダ展開・折り畳み** 機能

### **3. フィルタリング機能:**

#### **選択反映:**
```python
# 選択されたフォルダからページIDリストを生成
selected_page_ids = [
    "640450787", "640450788", "640450789", ...
]

# Confluence検索クエリに反映
query = f"text ~ '{user_keyword}' AND space = 'CLIENTTOMO'"
if selected_page_ids:
    ids_filter = " OR ".join([f"id = {pid}" for pid in selected_page_ids])
    query += f" AND ({ids_filter})"
```

#### **エージェント連携:**
- 選択フォルダ情報をプロンプトに追加
- 「以下のフォルダから検索してください: ■要件定義, テスト要件」
- 検索結果の関連性向上

## 🔧 技術実装

### **1. ファイル構成:**

```
src/spec_bot_mvp/
├── data/
│   ├── confluence_hierarchy.json
│   └── cache_metadata.json
├── tools/
│   ├── confluence_tool.py          # 既存 + JSON読み込み機能
│   └── hierarchy_manager.py        # 新規: JSON管理
├── ui/
│   └── streamlit_app.py            # 階層フィルターUI追加
└── utils/
    └── json_hierarchy_loader.py    # 新規: JSON操作
```

### **2. 主要クラス設計:**

```python
class HierarchyManager:
    """階層データ管理クラス"""
    
    def load_hierarchy() -> Dict
    def update_hierarchy() -> bool
    def get_page_ids_in_folders(folder_names: List[str]) -> List[str]
    def is_update_needed() -> bool

class JsonHierarchyLoader:
    """JSON階層データローダー"""
    
    def load_from_file() -> Dict
    def save_to_file(data: Dict) -> bool
    def create_backup() -> bool
    def validate_structure(data: Dict) -> bool
```

### **3. パフォーマンス目標:**

| 機能 | 現在 | 目標 | 改善率 |
|------|------|------|--------|
| 初回読み込み | 3-10秒 | 0.1秒 | **30-100倍** |
| フィルター選択 | 1-2秒 | 即時 | **即座** |
| UI応答性 | 重い | 軽快 | **大幅改善** |

## 🧪 テスト仕様

### **1. 単体テスト:**
- JSON読み込み・保存機能
- 階層データ解析機能  
- フォルダ配下ページID取得
- エラーハンドリング

### **2. 統合テスト:**
- UI操作フロー
- フィルタリング精度
- エージェント連携
- 更新プロセス

### **3. パフォーマンステスト:**
- 読み込み速度測定
- メモリ使用量確認
- 大量データ処理

## 📅 実装計画（更新版）

### **Phase 1: Confluenceフィルター簡素化 (半日)**
- [ ] 不要機能削除（スペース・コンテンツタイプ選択）
- [ ] 削除・廃止ページ除外ロジック実装
- [ ] 「削除ページを含む」チェックボックス追加
- [ ] 除外件数表示機能

### **Phase 2: JSON基盤実装 (1-2日)**
- [ ] JSON構造設計・確定（削除フラグ対応）
- [ ] HierarchyManager実装
- [ ] 基本的なJSON読み書き機能
- [ ] 削除・廃止ページ検知機能

### **Phase 3: UI階層表示 (1-2日)**  
- [ ] 階層チェックボックスUI
- [ ] フォルダ選択ロジック
- [ ] 削除ページアイコン表示（🗑️）
- [ ] フィルター状態表示

### **Phase 4: フィルター連携 (1日)**
- [ ] 削除ページフィルター連携
- [ ] 階層選択フィルター連携
- [ ] エージェントとの連携
- [ ] 検索クエリ生成調整

### **Phase 5: 更新機能 (1日)**
- [ ] 自動更新機能
- [ ] 手動更新ボタン
- [ ] エラーハンドリング

### **Phase 6: テスト・調整 (1日)**
- [ ] 削除ページフィルターテスト
- [ ] 階層フィルターテスト
- [ ] パフォーマンス調整
- [ ] UI/UX改善

**総開発期間: 5.5-7.5日**

## 🚀 期待効果

### **ユーザー体験:**
- ⚡ **即座のフィルター操作** - ストレスフリー
- 👁️ **視覚的な階層選択** - 直感的操作
- 🎯 **精密な絞り込み** - フォルダ単位選択

### **システム:**
- 🏃 **高速レスポンス** - 30-100倍高速化
- 🛡️ **安定性向上** - API依存削減
- 🔧 **保守性向上** - 構造化データ管理

### **開発・運用:**
- 📊 **デバッグ容易** - JSON可視化
- 🔄 **更新制御** - 適切なタイミング調整
- 💾 **リソース効率** - API呼び出し削減

---

**この仕様書に基づいて段階的に実装していきます。何かご質問や調整したい点はありますか？** 