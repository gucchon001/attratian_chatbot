# SPEC-DS-001 開発設計書

| バージョン | ステータス | 作成日 | 参照ドキュメント |
| :--- | :--- | :--- | :--- |
| **v4.0** | **段階開発方針版** | 2025/01/17 | SPEC-PL-001 v3.6 |

**v4.0更新内容:**
- 3段階開発方針の技術設計への反映
- Stage 1: Confluence専用Agent設計に特化
- ハイブリッドアーキテクチャの技術詳細更新

---

## 1. はじめに
本ドキュメントは、「仕様書作成支援ボット」を**3段階の段階開発**で確実に価値提供するための技術設計と開発手順を定義する。

### **段階開発方針の技術的反映**
- **Stage 1**: Confluence専用LangChain Agent + 3段階CQL検索最適化
- **Stage 2**: Jira統合Agent + 統合検索結果マージロジック
- **Stage 3**: エンタープライズレベル統合UI + 高度フィルター完全版

本設計書では主にStage 1の技術仕様を詳述し、Stage 2-3の拡張ポイントを明記する。

---

## 2. 新アーキテクチャ概要 (LangChainベース)

本システムは、LangChainの**Agent（エージェント）**を中核に据えたアーキテクチャを採用する。Agentはユーザーの指示を理解し、自律的に最適な「道具（Tool）」を選択・実行し、その結果を元に最終的な回答を生成する頭脳として機能する。

![LangChainアーキテクチャ図](https://i.imgur.com/r6b3g1M.png)
*(この図は概念を示しており、内部ではLangChain Agentが司令塔として動作します)*

* **UI (Streamlit):** ユーザーからの入力を受け取り、Agentの最終的な回答を表示する。
* **Agent (LangChain):** ユーザーの入力、会話履歴（Memory）、利用可能な道具（Tools）を考慮し、次に何をすべきかを判断する。
* **Tools (LangChain):** `Jira検索`や`Confluence検索`といった、私たちが実装する個別の機能をAgentが利用できる「道具」として定義したもの。
* **LLM (Gemini API):** Agentの思考エンジン。ユーザーの意図を解釈し、どの道具を使うべきか判断し、最終的な回答を生成するために使われる。
* **Memory (LangChain):** 過去の会話履歴を記憶し、Agentが文脈を理解した応答をするために利用される。

---

## 3. 技術選定
* **UIフレームワーク:** `Streamlit`
* **中核フレームワーク:** `LangChain`
* **LLM:** `Gemini API (via langchain-google-genai)`
* **外部連携API:** `Atlassian REST API (via atlassian-python-api)`

---

## 4. 実装済み機能一覧

### 4.1. **中核機能（Core）**
| 機能 | 実装状況 | 実装詳細 |
|:---|:---|:---|
| **HybridSearchApplication** | **✅ 完了** | **Step1-5統合パイプライン、Agent層統合、思考プロセス可視化、設定管理統合済み** |
| **ResponseGenerationAgent** | **✅ 完了** | **CLIENTTOMO最適化プロンプト、ソース情報付き回答生成、信頼度表示、LangChain最新API対応済み** |
| **FallbackSearchAgent** | **✅ 完了** | **ReAct型Agent、探索的検索、設定自動補完、AtlassianAPIClient連携、NoneTypeエラー修正済み** |
| **AgentSelector** | **✅ 完了** | **品質スコア閾値判定、Agent選択ロジック、連携履歴管理機能実装済み** |
| **AgentHandoverManager** | **✅ 完了** | **Step5統合管理、Agent連携制御、メタデータ管理、エラーハンドリング実装済み** |

### 4.2. **検索エンジン（Search Engines）**
| 機能 | 実装状況 | 実装詳細 |
|:---|:---|:---|
| **HybridSearchTool** | **✅ 完了** | **Step1-4統合実行、5段階プロセス管理、品質評価連携済み** |
| **CQL検索エンジン** | **✅ 完了** | **CLIENTTOMO最適化3段階戦略、92%+精度達成、階層フィルター連携済み** |
| **JQL検索エンジン** | **⚠️ 基盤完了** | **3段階戦略実装、12パラメータ対応、統合テスト完了、Stage2で本格運用** |
| **キーワード抽出** | **✅ 完了** | **GeminiAPI統合、CLIENTTOMO辞書、除外ルール、4キーワード最適化済み** |
| **データソース判定** | **✅ 完了** | **インテント分析、6カテゴリ分類、settings.ini準拠、精度向上実装済み** |
| **品質評価エンジン** | **✅ 完了** | **関連度スコア算出、ランキング機能、Agent選択支援機能実装済み** |

### 4.3. **UI/UX機能**
| 機能 | 実装状況 | 実装詳細 |
|:---|:---|:---|
| **統合版StreamlitUI** | **✅ 完了** | **思考プロセス可視化、フィルター統合、履歴クリア、ワンクリック深掘り検索実装済み** |
| **5段階プロセス可視化** | **✅ 完了** | **アコーディオン形式、詳細メトリクス、実行時間・結果数表示機能実装済み** |
| **JSON階層フィルター** | **✅ 完了** | **高速チェックボックス、削除ページ除外、30-100倍高速化達成済み** |
| **SQLiteキャッシュ** | **✅ 完了** | **1時間キャッシュ、手動更新、フィルター選択肢管理機能実装済み** |
| **会話メモリ機能** | **✅ 完了** | **ConversationBufferMemory、文脈依存質問、メモリクリア機能実装済み** |
| **深掘り検索機能** | **✅ 完了** | **ワンクリックボタン、関連キーワード自動生成、メモリ統合実装済み** |

### 4.4. **設定・運用管理**
| 機能 | 実装状況 | 実装詳細 |
|:---|:---|:---|
| **Settings統合管理** | **✅ 完了** | **settings.ini必須化、secrets.env分離、AtlassianURL自動構築、全機能統一済み** |
| **AtlassianAPIClient** | **✅ 完了** | **認証統合、エラーハンドリング、リトライ機能、設定自動補完実装済み** |
| **ログ管理システム** | **✅ 完了** | **構造化ログ、デバッグ支援、プロセス追跡、エラー診断機能実装済み** |
| **エラー処理機能** | **✅ 完了** | **NoneType修正、LangChain非推奨API対応、Agent初期化エラー解決済み** |

### 4.5. **パフォーマンス最適化**
| 機能 | 実装状況 | 実装詳細 |
|:---|:---|:---|
| **検索速度最適化** | **✅ 完了** | **30-100倍高速化、キャッシュ活用、並列処理実装済み** |
| **UI応答性向上** | **✅ 完了** | **リアルタイム更新、プログレス表示、非同期処理実装済み** |
| **メモリ効率化** | **✅ 完了** | **JSON+SQLiteハイブリッド、階層データ最適化実装済み** |
| **設定読み込み最適化** | **✅ 完了** | **configparser活用、フォールバック機能、URL自動構築実装済み** |