# 仕様書作成支援ボット 要件定義書

| バージョン | ステータス | 作成日 | 作成者 |
| :--- | :--- | :--- | :--- |
| **v3.6** | **最新版** | 2025/01/17 | AI Assistant |

**v3.6更新内容:**
- MVP-UI-04: LLMプロセス可視化機能の要件追加
- 5段階プロセス（質問解析→ツール選択→検索実行→結果統合→回答生成）の詳細仕様
- リアルタイム進行度表示とアコーディオン展開UI仕様
- ユーザビリティ向上・透明性向上・デバッグ支援機能の要件定義

**v3.5更新内容:**
- Jiraフィルター機能強化の要件追加（3.1.2章新設）
- 3→12パラメータ拡張、CTJ専用カスタムフィールド対応
- JSON階層フィルター機能強化の要件追加（3.1.3章新設）
- Confluenceフィルター性能問題の解決方針記載
- 30-100倍パフォーマンス向上目標の設定
- 階層チェックボックス・削除ページ除外機能の要件定義

**v3.4更新内容:**
- フィルター機能の詳細仕様を追加（Jira12パラメータ、Confluence4パラメータ）
- SQLiteキャッシュシステム仕様の詳細記載
- パフォーマンス指標の具体化（初回3-5秒→2回目0.1秒）
- JQL/CQLクエリ生成例の追加

---

## 1. 概要

### 1.1. プロジェクトの背景と課題
現在の開発プロセスにおいて、仕様や要件に関する情報はJira、Confluence、Googleスプレッドシート、Figma、BigQueryなど複数の場所に散在している。この情報のサイロ化は、チームの生産性を阻害する深刻な課題となっている。具体的には、以下の問題が発生している。

* **探索コストの増大:** 開発者やPMが、仕様を確認するために複数のツールを横断して情報を探し出すのに多くの時間を費やしている。
* **情報の分断とコンテキストの喪失:** 各情報源の関連性が不明瞭なため、なぜその仕様になったのかという背景や、プロジェクトの全体像を正確に把握することが困難になっている。
* **ドキュメント作成の非効率:** 新規機能の仕様書を作成する際、毎回ゼロから関連情報を収集・整理する必要があり、多大な手間と時間がかかっている。
* **認識の齟齬と手戻りの発生:** 情報の散재が原因で、チームメンバー間（開発、PM、CS、マーケティング等）での仕様認識にズレが生じ、開発終盤での手戻りやバグの温床となっている。
* **動的要素の確認困難:** モーダルウィンドウの挙動など、動的なUIの仕様がドキュメントから読み取りにくく、「これは仕様か、バグか」の判断に工数がかかっている。

### 1.2. プロジェクトの目的とゴール
本プロジェクトは、組織内のあらゆる仕様情報を横断的に検索・要約・提示するAIチャットボットを開発し、ドキュメント関連業務の抜本的な効率化と、チーム全体の生産性向上を実現することを目的とする。

* **目的:** チームの誰もが、必要な仕様情報へ迅速かつ正確に、そして文脈を理解した上でアクセスできる「Single Source of Truth（信頼できる唯一の情報源）」へのゲートウェイを構築する。
* **ゴール（成功の定義）:**
    * 仕様書の探索、作成、確認に関わる工数を**50%削減**する。
    * 仕様の認識齟齬に起因する開発の手戻りを**30%削減**する。
    * バグ発生時の原因調査とチケット作成にかかる時間を**平均1時間短縮**する。

---

## 2. アーキテクチャと技術選定

### 2.1. 基本アーキテクチャ
本ボットは、**LangChainフレームワーク**の**Agent（エージェント）**を中核に据えたアーキテクチャを採用する。Agentはユーザーの指示と会話の文脈を理解し、自律的に最適な「道具（Tool）」を選択・実行し、その結果を元に最終的な回答を生成する頭脳として機能する。このアーキテクチャにより、単純な一問一答に留まらない、柔軟で拡張性の高い対話体験を実現する。

### 2.2. 技術スタック

| 分類 | 選定技術 | 選定理由 |
| :--- | :--- | :--- |
| **UIフレームワーク** | Streamlit | Pythonのみで迅速にインタラクティブなUIを構築でき、プロトタイピングとアジャイルな開発に最適であるため。 |
| **中核フレームワーク** | LangChain | LLMアプリケーション開発の複雑さを抽象化し、会話メモリ、エージェント、ツール連携などの機能を効率的に実装できるため。 |
| **LLM** | Gemini API | 高度な日本語読解能力と要約性能を持ち、API経由で手軽に利用開始できるため。初期開発のスピードを重視する。 |
| **外部連携ライブラリ** | atlassian-python-api | JiraおよびConfluenceのAPIをPythonから容易に扱うための実績あるラッパーライブラリであるため。 |

---

## 3. 機能要件

### 3.1. MVP (Minimum Viable Product) スコープ
ユーザーテストで実用性を検証できる、最小限かつ価値ある機能群を定義する。

| ID | 機能名 | 機能概要 |
| :--- | :--- | :--- |
| MVP-Core-01 | LangChainエージェントの実装 | ユーザーの自然言語による指示を解釈し、会話の文脈（メモリ）を考慮しながら、利用可能なツールを自律的に呼び出す中核的な思考エンジンを構築する。 |
| MVP-Core-02 | 会話メモリ機能 | 直前の会話の内容を記憶し、「そのチケットについて詳しく」といった文脈に依存する追加質問に的確に応答できる能力。 |
| MVP-Tool-01 | Jira検索ツール | キーワードに基づき関連するJiraチケットを検索する機能を、エージェントが利用可能な「道具」として実装する。 |
| MVP-Tool-02 | Confluence検索ツール | キーワードに基づき関連するConfluenceページを検索する機能を、エージェントが利用可能な「道具」として実装する。 |
| MVP-UI-01 | インタラクティブ・チャットUI | Streamlitを用いて、ユーザーがボットと対話するための画面を構築する。会話履歴の表示、テキスト入力、送信機能を含む。 |
| **MVP-UI-02** | **高度なフィルター機能** | **(★MVPスコープに昇格) Streamlitサイドバーで検索条件を詳細に絞り込める機能。Jira12パラメータ（プロジェクト、ステータス、担当者、チケットタイプ、優先度、報告者、カスタムフィールド2種、作成日範囲、更新日範囲）とConfluence4パラメータ（スペース、コンテンツタイプ、作成日範囲）に対応。JQL/CQLクエリを動的生成して高精度検索を実現する。** |
| **MVP-UI-03** | **フィルター選択肢のキャッシュ機能** | **(★MVPスコープに昇格) SQLiteベースのキャッシュシステムで、フィルター選択肢（プロジェクト一覧、ステータス一覧等）を1時間キャッシュ。初回読み込み3-5秒→2回目以降0.1秒に高速化。UI上の「選択肢を更新」ボタンで手動強制更新も可能。** |
| **MVP-UI-04** | **LLMプロセス可視化機能** | **チャット回答生成中に、LLMエージェントの思考プロセスをアコーディオン形式でリアルタイム表示する機能。質問解析→ツール選択→検索実行→結果統合→回答生成の5段階プロセスを可視化し、ユーザーに処理状況の透明性と安心感を提供。各段階で詳細情報（検索クエリ、取得件数、実行時間等）を展開可能なexpander形式で表示。** |

### 3.1.1. 高度なフィルター機能の詳細仕様

本項では、MVP-UI-02で定義された高度なフィルター機能の技術的詳細を明記する。

#### **Jiraフィルター仕様（12パラメータ対応）**

| パラメータ名 | データ型 | JQLクエリ形式 | 例 | 備考 |
| :--- | :--- | :--- | :--- | :--- |
| **project_keys** | `List[str]` | `project = "KEY"` | `project = "CTJ" OR project = "SAMPLE"` | プロジェクトキーによる絞り込み |
| **status_names** | `List[str]` | `status = "STATUS"` | `status = "進行中" OR status = "完了"` | ステータス名による絞り込み |
| **assignee_ids** | `List[str]` | `assignee = "ID"` | `assignee = "accountId123"` | 担当者アカウントIDによる絞り込み |
| **issue_types** | `List[str]` | `issuetype = "TYPE"` | `issuetype = "Bug" OR issuetype = "Story"` | チケットタイプによる絞り込み |
| **priorities** | `List[str]` | `priority = "PRIORITY"` | `priority = "High" OR priority = "Medium"` | 優先度による絞り込み |
| **reporter_ids** | `List[str]` | `reporter = "ID"` | `reporter = "accountId456"` | 報告者アカウントIDによる絞り込み |
| **custom_tantou** | `List[str]` | `customfield_10277 = "VALUE"` | `customfield_10277 = "フロントエンド"` | CTJプロジェクト専用：担当カスタムフィールド |
| **custom_eikyou_gyoumu** | `List[str]` | `customfield_10291 = "VALUE"` | `customfield_10291 = "ユーザー認証"` | CTJプロジェクト専用：影響業務カスタムフィールド |
| **created_after** | `str (YYYY-MM-DD)` | `created >= "DATE"` | `created >= "2024-01-01"` | 作成日以降による絞り込み |
| **created_before** | `str (YYYY-MM-DD)` | `created <= "DATE"` | `created <= "2024-12-31"` | 作成日以前による絞り込み |
| **updated_after** | `str (YYYY-MM-DD)` | `updated >= "DATE"` | `updated >= "2024-06-01"` | 更新日以降による絞り込み |
| **updated_before** | `str (YYYY-MM-DD)` | `updated <= "DATE"` | `updated <= "2024-12-31"` | 更新日以前による絞り込み |

#### **Confluenceフィルター仕様（4パラメータ対応）**

| パラメータ名 | データ型 | CQLクエリ形式 | 例 | 備考 |
| :--- | :--- | :--- | :--- | :--- |
| **space_keys** | `List[str]` | `space = "KEY"` | `space = "TECH" OR space = "DESIGN"` | スペースキーによる絞り込み |
| **content_type** | `str` | `type = "TYPE"` | `type = "page"` | page または blogpost |
| **created_after** | `str (YYYY-MM-DD)` | `created >= "DATE"` | `created >= "2024-01-01"` | 作成日以降による絞り込み |
| **created_before** | `str (YYYY-MM-DD)` | `created <= "DATE"` | `created <= "2024-12-31"` | 作成日以前による絞り込み |

#### **3.1.2. Jiraフィルター機能強化（v3.5追加）**

**背景:**
従来の基本的なJiraフィルター（3パラメータ）では、複雑な検索条件に対応できず、ユーザーが求める精密な絞り込みが困難な状況を改善。

**概要:**
- 基本フィルター（3項目） → 詳細フィルター（12項目）への大幅拡張
- CTJプロジェクト専用カスタムフィールド対応
- 日付範囲指定による時系列分析機能
- 複雑なJQLクエリの自動生成

**主要改善項目:**
- **フィルター拡張**: 3 → 12パラメータ（4倍の絞り込み能力）
- **専用対応**: CTJプロジェクト固有のワークフロー・フィールドサポート
- **日付分析**: 作成日・更新日・解決日・期限の4種類の範囲指定
- **UI改善**: アコーディオン型の段階的展開とリアルタイム絞り込み

**拡張されたフィルター項目:**
| 項目 | 従来 | 拡張後 | 追加内容 |
|:---|:---|:---|:---|
| **基本情報** | プロジェクト、ステータス、担当者 | 同左 + チケットタイプ、優先度、報告者 | 3項目追加 |
| **カスタムフィールド** | なし | 担当（10277）、影響業務（10291） | 2項目追加 |
| **日付フィルター** | なし | 作成日、更新日、解決日、期限（各々範囲指定） | 4項目追加 |

**技術仕様:**
- JQLクエリ自動生成（複雑な条件組み合わせ対応）
- SQLiteキャッシュによる高速選択肢取得
- リアルタイムバリデーション機能

**📄 詳細仕様:** [画面設計書 v1.6](./仕様書作成支援ボット%20画面設計書.md) を参照

#### **3.1.4. LLMプロセス可視化機能（v3.6追加）**

**背景:**
従来のチャット機能では、LLMの回答生成中は単純な「回答を生成中...」スピナーのみが表示され、ユーザーが実際の処理状況を把握できないため、長時間の処理で不安を感じる課題があった。

**概要:**
- LLMエージェントの思考プロセスをリアルタイムで可視化
- 5段階プロセス（質問解析→ツール選択→検索実行→結果統合→回答生成）の詳細表示
- アコーディオン形式での展開可能な詳細情報表示
- プロセス進行度の視覚的インジケーター

**主要改善項目:**
- **透明性向上**: LLMの思考プロセスを可視化し、ユーザーの理解度向上
- **安心感提供**: 各プロセス段階の進行状況を明示し、処理継続の確信を与える
- **デバッグ支援**: 開発者が処理ボトルネックや問題箇所を特定しやすくする
- **ユーザビリティ向上**: 処理時間の体感を短縮し、インタラクション品質を向上

**プロセス段階仕様:**
| 段階 | 処理内容 | 表示情報 | 推定時間 |
|:---|:---|:---|:---|
| **1. 質問解析** | ユーザー入力の解析、キーワード抽出、検索対象判定 | 検出キーワード、推定検索対象、適用フィルター | 0.5-1秒 |
| **2. ツール選択** | 利用可能ツールから最適な組み合わせを選択 | 選択ツール、優先順位、実行戦略 | 0.3-0.7秒 |
| **3. 検索実行** | Jira/Confluence APIの並列実行、データ取得 | 実行中ツール、取得件数、詳細クエリ、実行時間 | 2-5秒 |
| **4. 結果統合** | 検索結果の関連性分析、重複除去、優先度付け | マッチ度、重複除去件数、カテゴリ分類 | 0.5-1.5秒 |
| **5. 回答生成** | LLMによる最終要約、参照リンク生成 | 要約精度、参照リンク数、生成文字数 | 2-4秒 |

**UI表示仕様:**
- **進行度バー**: `st.progress()` で全体進行度（0-100%）を表示
- **段階別表示**: `st.expander()` で各段階の詳細情報を展開可能
- **ステータスアイコン**: ✅完了、🔄実行中、⏳待機中 でプロセス状態を視覚化
- **詳細情報**: 各段階で実行されたクエリ、取得データ、処理時間等を詳細表示

#### **3.1.3. JSON階層フィルター機能強化（v3.5追加）**

**背景:**
Confluence4パラメータフィルターの性能課題（3-10秒の待機時間）を解決し、ユーザビリティを大幅向上させる技術的改善を実施。

**概要:**
- APIリアルタイム取得 → JSONローカルファイル方式への変更
- 階層チェックボックスによる直感的フォルダ選択  
- 削除・廃止ページの自動除外機能

**主要改善項目:**
- **パフォーマンス**: 30-100倍高速化（3-10秒 → 0.1秒以下）
- **UX向上**: 即座のフィルター操作、視覚的階層選択
- **機能簡素化**: 不要な機能（スペース・コンテンツタイプ選択）の削除
- **データ品質**: 削除・廃止ページの適切な管理

**技術仕様:**
- JSONファイルベースの階層データ管理
- 週1回の自動更新 + 手動更新機能
- SQLiteキャッシュとの連携

**📄 詳細仕様:** [JSON階層フィルター機能_仕様書.md](./JSON階層フィルター機能_仕様書.md) を参照

#### **キャッシュシステム仕様**

| 項目 | 仕様 | 実装詳細 |
| :--- | :--- | :--- |
| **データベース** | SQLite | `cache/filter_cache.db` |
| **テーブル構造** | `(cache_key, data, created_at, expires_at)` | JSON文字列でシリアライズ |
| **キャッシュ有効期間** | 1時間 | 設定可能（default: 24時間） |
| **キャッシュキー** | `jira_filter_options`, `confluence_spaces` | 機能別にキー分離 |
| **強制更新** | UIボタン経由 | `force_update=True`フラグ |
| **パフォーマンス** | 初回3-5秒 → 2回目以降0.1秒 | 30-50倍の高速化達成 |

#### **UI配置・操作仕様**

```
Streamlitサイドバー構成：
🔍 高度な検索フィルター
├── 📋 Jiraフィルター（展開可能アコーディオン）
│   ├── プロジェクト：セレクトボックス（「すべて」+ 実際のプロジェクト一覧）
│   ├── ステータス：セレクトボックス（「すべて」+ 実際のステータス一覧）
│   └── 担当者：セレクトボックス（「すべて」+ 最近のアクティブユーザー50名）
├── 📚 Confluenceフィルター（展開可能アコーディオン）
│   └── スペース：セレクトボックス（「すべて」+ 実際のスペース一覧）
├── 🗑️ フィルターをクリア（ボタン）
├── 🔄 選択肢を更新（ボタン）- キャッシュ強制更新
└── 📊 現在のフィルター状態（動的表示）
```

### 3.2. 将来の拡張スコープ
MVPの成功後、ボットを「能動的なアシスタント」「ワークフローの自動化ツール」へと進化させるため、以下の機能拡張を検討する。

#### **ユーザビリティ向上**
| ID | 機能名 | 機能概要 |
| :--- | :--- | :--- |
| **US-01** | **会話履歴の閲覧・検索機能** | **(★新規追加) 過去の全会話履歴を永続化し、専用のUIで検索・閲覧できる機能。** |

#### **データソース拡張**
* **EXT-01: Googleスプレッドシート連携**
* **EXT-02: BigQueryテーブル定義書検索**

#### **高度な仕様・動作確認**
* **ADV-01: PostHog連携によるセッションリプレイ分析**
* **ADV-02: Figma API連携によるデザイン仕様参照**
* **ADV-03: Playwright等によるオンデマンド動作記録**

#### **ワークフロー自動化**
* **WFA-01: インタラクティブなチケット/ページ作成**
* **WFA-02: 影響範囲分析**
* **WFA-03: 会議アシスタント**
* **WFA-04: リリースノート自動生成**

#### **インテリジェンス・連携強化**
* **INT-01: ナレッジギャップの可視化**
* **INT-02: 担当者推薦 (Who to ask?)**
* **INT-03: Slack / Microsoft Teams連携**

---

## 4. 非機能要件

| 項目 | 要件 |
| :--- | :--- |
| **パフォーマンス** | 応答時間は30秒以内を目標とする。処理に時間がかかる場合は、進捗状況（例：「Jiraを検索中...」）をリアルタイムで表示し、最大1分まで許容する。フィルター選択肢の読み込みは、初回3-5秒、キャッシュ利用時0.1秒以内を実現する。検索結果件数に応じて応答時間が変動するが、通常の業務利用範囲（50-500件）では10-30秒以内を維持する。 |
| **セキュリティ** | APIキーなどの認証情報は、ローカル開発では`.env`ファイルで管理し、コードに直接記述しない。本番環境ではStreamlit Secretsやクラウドサービスのシークレット管理機能を利用し、最大限のセキュリティを確保する。 |
| **ユーザビリティ** | 初回起動時にボットの能力と使い方（例：「ログイン機能について教えて」）を簡潔に表示する。エラー発生時には、ユーザーが次にとるべきアクションがわかるような、親切で具体的なメッセージを表示する。 |
| **可用性** | 本番環境では、24時間365日利用可能であることを目指す。ただし、メンテナンスのための計画停止はこの限りではない。 |

## 5. スコープ外の事項 (MVP時点)
* 本ボットは情報の**読み取り専用**とし、Jiraチケットのステータス変更やConfluenceページの書き込み・更新機能は含まない。
* ユーザーごとのアクセス権限制御は行わず、ボットに設定された単一のAPIキーの権限範囲で動作する。
* ユーザーごとの会話履歴の永続的な保存は行わない（ブラウザセッション内でのみ保持）。

## 6. 開発後の展開ロードマップ
MVPは完成がゴールではなく、価値を検証し、プロダクトを成長させるためのスタート地点である。以下のステップでプロジェクトを推進する。

### Step 1: 限定的なリリースとフィードバック収集 (1ヶ月)
* まずPMとCSチームなど、利用頻度が高い少数チームにMVPを限定公開する。
* 定期的なヒアリングやアンケートを実施し、「検索精度」「要約の質」「使い勝手」に関する定性・定量のフィードバックを収集する。「どんなキーワードで検索したか」「期待した結果が得られたか」などの利用ログも分析の対象とする。

### Step 2: MVPの改善と安定化 (1ヶ月)
* 収集したフィードバックに基づき、MVPの改善を行う。特に、検索キーワードのマッチングロジックや、AIによる要約のプロンプトチューニングを重点的に実施する。
* 利用者が拡大しても安定して稼働するよう、パフォーマンスの監視と改善を行う。

### Step 3: 拡張機能の開発 (3ヶ月〜)
* 安定したMVP基盤の上で、**機能要件3.2**で定義した拡張機能の開発に着手する。
* 開発の優先順位は、Step1で収集したフィードバックを元に、最も費用対効果が高いと判断されるものから決定する。（例：スプレッドシート連携の要望が多ければ、EXT-01から着手）