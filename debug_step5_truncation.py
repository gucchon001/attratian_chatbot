#!/usr/bin/env python3
"""
Step5 å›ç­”ç”Ÿæˆé€”ä¸­åœæ­¢å•é¡Œãƒ‡ãƒãƒƒã‚°ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
"""

import sys
from pathlib import Path

# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆã‚’ãƒ‘ã‚¹ã«è¿½åŠ 
project_root = Path(__file__).parent
sys.path.insert(0, str(project_root))

try:
    from src.spec_bot_mvp.agents.response_generator import ResponseGenerationAgent
    
    print("=" * 60)
    print("ğŸ” Step5 å›ç­”ç”Ÿæˆé€”ä¸­åœæ­¢å•é¡Œãƒ‡ãƒãƒƒã‚°")
    print("=" * 60)
    
    # ãƒ†ã‚¹ãƒˆç”¨æ¤œç´¢çµæœï¼ˆå®Ÿéš›ã®ãƒ­ã‚°ã‚¤ãƒ³æ©Ÿèƒ½ãƒ‡ãƒ¼ã‚¿ï¼‰
    test_search_results = [
        {
            "id": "703889475",
            "title": "042_ã€FIXã€‘ä¼šå“¡ãƒ­ã‚°ã‚¤ãƒ³ãƒ»ãƒ­ã‚°ã‚¢ã‚¦ãƒˆæ©Ÿèƒ½",
            "content": """1. ç›®æ¬¡
2. æ¦‚è¦
ä¼šå“¡ãŒã‚µãƒ¼ãƒ“ã‚¹ã‚µã‚¤ãƒˆã«ã¦ãƒ­ã‚°ã‚¤ãƒ³ã€ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã‚’è¡Œã†ãŸã‚ã®æ©Ÿèƒ½ã§ã™ã€‚
3. è¦æ±‚äº‹é …
3.1.1. ãƒ­ã‚°ã‚¤ãƒ³æ©Ÿèƒ½
ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã€ç™»éŒ²æ¸ˆã¿æƒ…å ±ã¨ä¸€è‡´ã™ã‚Œã°ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã€‚
ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®å…¥åŠ›è¦åˆ¶ã¯ ã«è¨˜è¼‰ã®å†…å®¹ã«æº–ãšã‚‹ã€‚
ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯ä»¥ä¸‹ã®å…¥åŠ›è¦åˆ¶ã‚’è¨­ã‘ã‚‹ã€‚
8æ–‡å­—ä»¥ä¸Š50æ–‡å­—ä»¥ä¸‹ã§ã‚ã‚‹ã“ã¨ã€‚ï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®è¦³ç‚¹ã‹ã‚‰ãƒ­ã‚°ã‚¤ãƒ³æ™‚ã®å…¥åŠ›ã¯æ–‡å­—æ•°ãƒã‚§ãƒƒã‚¯ï¼‰
3.1.2. ãƒ­ã‚°ã‚¢ã‚¦ãƒˆæ©Ÿèƒ½
ãƒ­ã‚°ã‚¢ã‚¦ãƒˆãƒœã‚¿ãƒ³ã‚’æŠ¼ä¸‹ã™ã‚‹ã“ã¨ã§ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã§ãã‚‹ã€‚
ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå¾Œã¯ã‚µãƒ¼ãƒ“ã‚¹ã‚µã‚¤ãƒˆã®ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã«é·ç§»ã™ã‚‹ã€‚""",
            "url": "/spaces/CLIENTTOMO/pages/703889475/042_+FIX",
            "source": "confluence",
            "relevance_score": 1.0
        },
        {
            "id": "703824108", 
            "title": "681_ã€FIXã€‘ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆä¼æ¥­ãƒ­ã‚°ã‚¤ãƒ³ãƒ»ãƒ­ã‚°ã‚¢ã‚¦ãƒˆæ©Ÿèƒ½",
            "content": """1. ç›®æ¬¡
2. æ¦‚è¦
ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆä¼æ¥­ç®¡ç†è€…ãŒã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆä¼æ¥­ç®¡ç†ç”»é¢ã«ãƒ­ã‚°ã‚¤ãƒ³/ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã™ã‚‹ãŸã‚ã®æ©Ÿèƒ½ã€‚
3. è¦æ±‚äº‹é …
ãƒ­ã‚°ã‚¤ãƒ³æ©Ÿèƒ½
ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã€ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã€ä¼æ¥­ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ç™»éŒ²æ¸ˆã¿æƒ…å ±ã¨ä¸€è‡´ã™ã‚Œã°ã€ãƒ­ã‚°ã‚¤ãƒ³ã«æˆåŠŸã—ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆä¼æ¥­ç®¡ç†ç”»é¢ã®TOPãƒšãƒ¼ã‚¸ã¸é·ç§»ã™ã‚‹ã€‚
ã€Œãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¿˜ã‚ŒãŸã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ä¸‹ã™ã‚‹ã¨ ã«é·ç§»ã™ã‚‹ã€‚
ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã€ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®å…¥åŠ›ãƒ»ç™»éŒ²è¦åˆ¶ã¯ ã«è¨˜è¼‰ã®å†…å®¹ã«æº–ãšã‚‹ã€‚""",
            "url": "/spaces/CLIENTTOMO/pages/703824108/681_+FIX",
            "source": "confluence",
            "relevance_score": 0.95
        },
        {
            "id": "703529146",
            "title": "451_ã€FIXã€‘å…¨ä½“ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³ãƒ»ãƒ­ã‚°ã‚¢ã‚¦ãƒˆæ©Ÿèƒ½", 
            "content": """1. ç›®æ¬¡
2. æ¦‚è¦
å…¨ä½“ç®¡ç†è€…ãŒã€å…¨ä½“ç®¡ç†ç”»é¢ã«ãƒ­ã‚°ã‚¤ãƒ³/ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã™ã‚‹ãŸã‚ã®æ©Ÿèƒ½ã€‚
3. è¦æ±‚äº‹é …
ãƒ­ã‚°ã‚¤ãƒ³æ©Ÿèƒ½
ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ç™»éŒ²æ¸ˆã¿æƒ…å ±ã¨ä¸€è‡´ã™ã‚Œã°ã€ãƒ­ã‚°ã‚¤ãƒ³ã«æˆåŠŸã—ã€å…¨ä½“ç®¡ç†ç”»é¢ã®TOPãƒšãƒ¼ã‚¸ã¸é·ç§»ã™ã‚‹ã€‚
ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ãƒ»ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®å…¥åŠ›ãƒ»ç™»éŒ²è¦åˆ¶ã¯ ã«è¨˜è¼‰ã®å†…å®¹ã«æº–ãšã‚‹ã€‚
ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®å…¥åŠ›å€¤ã«èª¤ã‚ŠãŒã‚ã£ãŸå ´åˆã€ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«å…·ä½“çš„ãªç®‡æ‰€ã‚„å†…å®¹ã¯ç¤ºã•ãšã€åŒ…æ‹¬çš„ãªã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºã™ã‚‹ã€‚""",
            "url": "/spaces/CLIENTTOMO/pages/703529146/451_+FIX",
            "source": "confluence", 
            "relevance_score": 0.9
        }
    ]
    
    test_query = "ãƒ­ã‚°ã‚¤ãƒ³æ©Ÿèƒ½ã®è©³ç´°ã‚’æ•™ãˆã¦"
    
    print(f"\nğŸ“ ãƒ†ã‚¹ãƒˆã‚¯ã‚¨ãƒª: '{test_query}'")
    print(f"ğŸ“Š æ¤œç´¢çµæœæ•°: {len(test_search_results)}ä»¶")
    
    # Step5å›ç­”ç”Ÿæˆå®Ÿè¡Œ
    print("\nğŸ”„ Step5: å›ç­”ç”Ÿæˆå®Ÿè¡Œ")
    try:
        agent = ResponseGenerationAgent()
        print("âœ… ResponseGenerationAgentåˆæœŸåŒ–æˆåŠŸ")
        
        # è©³ç´°ãƒ‡ãƒãƒƒã‚°æƒ…å ±
        print(f"âœ… Geminiè¨­å®š:")
        print(f"   Model: {agent.settings.gemini_model}")
        print(f"   Temperature: {agent.settings.gemini_temperature}")
        print(f"   Max Tokens: {agent.settings.gemini_max_tokens}")
        
        # å®Ÿéš›ã®å›ç­”ç”Ÿæˆ
        print(f"\nğŸš€ å›ç­”ç”Ÿæˆé–‹å§‹...")
        response = agent.generate_response(test_search_results, test_query)
        
        print(f"âœ… å›ç­”ç”ŸæˆæˆåŠŸ")
        print(f"ğŸ“ å›ç­”é•·: {len(response)} æ–‡å­—")
        
        # å†…å®¹ç¢ºèª
        print(f"\nğŸ“„ å›ç­”å†…å®¹ï¼ˆæœ€åˆã®500æ–‡å­—ï¼‰:")
        print("-" * 50)
        print(response[:500])
        print("-" * 50)
        
        # é€”ä¸­åœæ­¢ãƒã‚§ãƒƒã‚¯
        lines = response.split('\n')
        if len(lines) < 10:
            print(f"âš ï¸ å›ç­”ãŒçŸ­ã™ãã‚‹å¯èƒ½æ€§: {len(lines)}è¡Œ")
        
        # ä¸å®Œå…¨çµ‚äº†ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒã‚§ãƒƒã‚¯
        incomplete_patterns = [
            "èªè¨¼æ–¹æ³•:",
            "ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯",
            "å…¥åŠ›ã•ã‚ŒãŸæƒ…å ±",
            "ã—ãŸå ´åˆã«"
        ]
        
        for pattern in incomplete_patterns:
            if response.endswith(pattern):
                print(f"âš ï¸ ä¸å®Œå…¨çµ‚äº†ã‚’æ¤œå‡º: '{pattern}'")
                break
        else:
            if len(response) > 1000:
                print(f"âœ… å®Œå…¨ãªå›ç­”ãŒç”Ÿæˆã•ã‚Œã¾ã—ãŸ")
            else:
                print(f"âš ï¸ å›ç­”ãŒçŸ­ã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™")
        
        # ç›´æ¥Geminiå‘¼ã³å‡ºã—ãƒ†ã‚¹ãƒˆ
        print(f"\nğŸ” ç›´æ¥Geminiå‘¼ã³å‡ºã—ãƒ†ã‚¹ãƒˆ")
        formatted_results = agent._format_search_results(test_search_results)
        
        direct_result = agent.chain.invoke({
            "search_results": formatted_results,
            "user_query": test_query
        })
        
        if direct_result and hasattr(direct_result, 'content'):
            direct_content = direct_result.content
            print(f"ğŸ“ ç›´æ¥å‘¼ã³å‡ºã—çµæœé•·: {len(direct_content)} æ–‡å­—")
            
            if len(direct_content) != len(response):
                print(f"âš ï¸ å‡¦ç†éç¨‹ã§å†…å®¹ãŒå¤‰æ›´ã•ã‚Œã¦ã„ã¾ã™")
                print(f"   ç›´æ¥å‘¼ã³å‡ºã—: {len(direct_content)}æ–‡å­—")
                print(f"   generate_response: {len(response)}æ–‡å­—")
            else:
                print(f"âœ… å‡¦ç†éç¨‹ã§å†…å®¹ã¯ä¿æŒã•ã‚Œã¦ã„ã¾ã™")
                
        else:
            print(f"âŒ ç›´æ¥Geminiå‘¼ã³å‡ºã—ã§ç©ºå¿œç­”")
            
    except Exception as e:
        print(f"âŒ Step5å›ç­”ç”Ÿæˆå¤±æ•—: {e}")
        import traceback
        traceback.print_exc()
    
    print("\n" + "=" * 60)
    print("ğŸ¯ Step5ãƒ‡ãƒãƒƒã‚°å®Œäº†")
    print("=" * 60)

except ImportError as e:
    print(f"âŒ ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼: {e}")
    sys.exit(1)
except Exception as e:
    print(f"âŒ äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼: {e}")
    import traceback
    traceback.print_exc()
    sys.exit(1)